<!DOCTYPE html>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<html lang="en">
<html>
  <head>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"> </script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"> </script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>
<body>
<script type="text/javascript">

// Thanks to & derived from:
// http://jsdatav.is/visuals.html?id=49b1d119e05b5efbf96e
// https://nyquist212.wordpress.com/2014/03/11/simple-d3-js-force-layout-example-in-less-than-100-lines-of-code/
// http://stackoverflow.com/questions/9901565/charge-based-on-size-d3-force-layout

/* Set the diagrams Height & Width */
    var h = 768, w = 1024;
/* Set the color scale we want to use */
//    var color = d3.scale.category20();
/* Establish/instantiate an SVG container object */
    var svg = d3.select("body")
                    .append("svg")
                    .attr("style","display:block;margin:auto" )
                    .attr("height",h)
                    .attr("width",w )
                    .attr("id","svg" );
/* Build the directional arrows for the links/edges */
        svg.append("svg:defs")
                    .selectAll("marker")
                    .data(["end"]) 
                    .enter().append("svg:marker")
                    .attr("id", String)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", -1.5)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .append("svg:path")
                    .attr("d", "M0,-5L10,0L0,5");
/* Pre-Load the json data using the queue library */
queue()
//    .defer(d3.json, "nodes.json")
    .defer(d3.json, "colours.json")
//    .defer(d3.json, "links.json")
    .await(makeDiag); 

var stuff = {
  circles : null,
  texts : null,
//  force : null,
  forceFn : function( node ) {
    //console.log( "node="+JSON.stringify( node ) );
    if( stuff.circles != null ) {
      var element = stuff.circles[0][ node.index ];
      var classValue = element.getAttribute( 'class' );
      if( classValue == 'big' ) {
        return -9000;
      } 
      else if( classValue == 'med' ) {
        return -6000;
      } 
    }

    return -3000;
  }
};

function hex2Rgb( hex ) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function rgb2Hsv( rgb ) {
  var r = rgb.r;
  var g = rgb.g;
  var b = rgb.b;
  var rgbArray = [rgb.r,rgb.g,rgb.b];
  var max = Math.max.apply(Math, rgbArray );
  var min = Math.min.apply(Math, rgbArray );
 
  var chr = max-min;
  var hue = 0;
  var val = max;
  var sat = 0;

  if( val > 0 ) {
    sat = chr/val;
    if( sat > 0 ) {
      if( r == max ) { 
        hue = 60*(((g-min)-(b-min))/chr);
        if (hue < 0) {hue += 360;}
      } else if (g == max) { 
        hue = 120+60*(((b-min)-(r-min))/chr); 
      } else if (b == max) { 
        hue = 240+60*(((r-min)-(g-min))/chr); 
      }
    } 
  }

  return { h: hue, s: sat, v: val };
}

function similarColour( colour1, colour2 ) {
//  var t = 50;
  var t = 6;
  var rgb1 = hex2Rgb( colour1 );
  var rgb2 = hex2Rgb( colour2 );
//  var dr = Math.abs( rgb1.r - rgb2.r );
//  var dg = Math.abs( rgb1.g - rgb2.g );
//  var db = Math.abs( rgb1.b - rgb2.b );
//  var d = dr + dg + db;
  var hsv1 = rgb2Hsv( rgb1 );
  var hsv2 = rgb2Hsv( rgb2 );

  var d = Math.abs( hsv1.h - hsv2.h );
  if( d < t ) {
    return true;
  }
  return false;
}

/* Define the main worker or execution function */
//function makeDiag(error, nodes, links, table) {
function makeDiag(error, nodes, table) {

    // build links based on colour similarity
    var links = [];
    for( var i = 0; i < nodes.length; i++ ) {
      var c1 = nodes[ i ].value;
      for( var j = 0; j < nodes.length; j++ ) {
        if( i == j ) continue;
        var c2 = nodes[ j ].value;
        if( !similarColour( c1, c2 ) ) {
          continue;
        }

        var link = { "source": i, "target": j };
        links.push( link );
      }
    }

    /* Establish the dynamic force behavor of the nodes */
    var force = d3.layout.force()
                    .nodes(nodes)
                    .links(links)
                    .size([w,h])
                    .linkDistance([50])
                    .charge( stuff.forceFn ) //[-1500])
//                    .gravity(0.3)
                    .gravity(4.3)
                    .start();
//    stuff.force = force;
    /* Draw the edges/links between the nodes */
    var edges = svg.selectAll("line")
                    .data(links)
                    .enter()
                    .append("line")
                    .style("stroke", "#ccc")
                    .style("stroke-width", 1)
                    .attr("marker-end", "url(#end)");
    /* Draw the nodes themselves */                
    var circles = svg.selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("circle")
                    .attr("r", 20)
//                    .attr("opacity", 0.5)
                    .style("fill", function(d,i) { 
//                        console.log( JSON.stringify( d ) );
//                      return color(i); 
                      return d.value; 
                    })
                    .call(force.drag);

    stuff.circles = circles;

    /* Draw the node labels first */
   var texts = svg.selectAll("text")
                    .data(nodes)
                    .enter()
                    .append("text")
                    .attr("fill", "black")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "10px")
                    .text(function(d) { return d.name; }); 

    stuff.texts = texts;

    /* Run the Force effect */
    force.on("tick", function() {
               edges.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });
               circles.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
               texts.attr("transform", function(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                });
	}); // End tick func

    $(document).mousemove( function( e ) {
      var svg = document.getElementById( "svg" );
      var x = e.pageX - svg.getBoundingClientRect().left;
      var y = e.pageY - svg.getBoundingClientRect().top;

      //////////////////////////////////////////
      var dThreshold = 150.0;
      var circles = $("#svg circle" );
      var dMin = screen.width * screen.width;
      var iMin = 0;

      var near = [];

      for( var i = 0; i < circles.length; i++ ) {
        var cx = parseFloat( circles[ i ].getAttribute( 'cx' ) );
        var cy = parseFloat( circles[ i ].getAttribute( 'cy' ) );
        var dx = x - cx;
        var dy = y - cy;
        var d = Math.sqrt( dx * dx + dy * dy );
        if( d < dMin ) {
          dMin = d;
          iMin = i;
        }
        if( d < dThreshold ) {
          near.push( i );
        }
      }

      var small = 20;
      var med = 30;
      var big = 40;

      for( var i = 0; i < circles.length; i++ ) {
        var radius = small;
        var classValue = "small";
        var fontSize = 10;
        if( i == iMin ) {
          radius = big;
          classValue = "big";
          fontSize = 32;
        }
        else {
          for( var j = 0; j < near.length; j++ ) {
            if( i == near[ j ] ) {
              radius = med;
              classValue = "med";
              fontSize = 18;
            }
          }
        }

        circles[ i ].setAttribute( 'r', radius );
        circles[ i ].setAttribute( 'class', classValue );
        var t = stuff.texts[0][ i ];
        t.style[ "font-size" ] = fontSize+"px";
      }
      force.start(); // restart the force due to new constraints
    } );

}; // End makeDiag worker func
</script>
</body>
</html>
